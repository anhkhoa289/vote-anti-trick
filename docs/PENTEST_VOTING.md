# Penetration Testing Guide - Voting Feature

## üéØ M·ª•c ti√™u Pentest

ƒê√°nh gi√° b·∫£o m·∫≠t ch·ª©c nƒÉng voting c·ªßa h·ªá th·ªëng Infrastructure Voting ƒë·ªÉ ph√°t hi·ªán v√† khai th√°c c√°c l·ªó h·ªïng b·∫£o m·∫≠t.

---

## üîç Ph√¢n t√≠ch H·ªá th·ªëng

### API Endpoints
- **POST** `/api/infrastructures/[id]/vote` - T·∫°o vote m·ªõi
- **GET** `/api/infrastructures` - L·∫•y danh s√°ch v·ªõi vote count
- **POST** `/api/infrastructures` - T·∫°o infrastructure m·ªõi

### Data Model
```typescript
Vote {
  id: String (CUID)
  infrastructureId: String
  voterName: String? (optional)
  voterEmail: String? (optional)
  ipAddress: String? (t·ª´ headers)
  createdAt: DateTime
}
```

### C∆° ch·∫ø B·∫£o m·∫≠t Hi·ªán t·∫°i
- ‚ùå KH√îNG c√≥ vote deduplication (kh√¥ng ki·ªÉm tra duplicate)
- ‚ùå KH√îNG c√≥ rate limiting
- ‚ùå KH√îNG c√≥ CSRF protection
- ‚ùå KH√îNG c√≥ authentication/authorization
- ‚ö†Ô∏è IP tracking d·ª±a tr√™n headers c√≥ th·ªÉ b·ªã spoof
- ‚úÖ Prisma ORM (gi·∫£m thi·ªÉu SQL injection)

---

## üö® C√°c L·ªó h·ªïng ƒê√£ Ph√°t hi·ªán

### 1. **CRITICAL: Unlimited Vote Manipulation**
**Severity:** üî¥ CRITICAL
**Location:** `app/api/infrastructures/[id]/vote/route.ts:30-38`

**M√¥ t·∫£:**
- Kh√¥ng c√≥ c∆° ch·∫ø ki·ªÉm tra duplicate vote
- M·ªôt user c√≥ th·ªÉ vote v√¥ h·∫°n l·∫ßn
- Ch·ªâ c·∫ßn g·ªçi API li√™n t·ª•c

**Impact:**
- Thao t√∫ng k·∫øt qu·∫£ b·∫ßu ch·ªçn
- T·∫°o vote spam kh√¥ng gi·ªõi h·∫°n
- L√†m m√©o m√≥ d·ªØ li·ªáu th·ªëng k√™

---

### 2. **HIGH: IP Spoofing**
**Severity:** üü† HIGH
**Location:** `app/api/infrastructures/[id]/vote/route.ts:14-16`

**M√¥ t·∫£:**
```typescript
const ipAddress = request.headers.get('x-forwarded-for') ||
                  request.headers.get('x-real-ip') ||
                  'unknown'
```
- Headers `x-forwarded-for` v√† `x-real-ip` c√≥ th·ªÉ b·ªã gi·∫£ m·∫°o
- Attacker c√≥ th·ªÉ fake IP ƒë·ªÉ bypass tracking

**Impact:**
- Bypass IP-based tracking (n·∫øu c√≥ implement sau n√†y)
- T·∫°o vote t·ª´ nhi·ªÅu "IP" kh√°c nhau

---

### 3. **HIGH: No Rate Limiting**
**Severity:** üü† HIGH
**Location:** To√†n b·ªô API endpoints

**M√¥ t·∫£:**
- Kh√¥ng c√≥ gi·ªõi h·∫°n s·ªë l∆∞·ª£ng request
- C√≥ th·ªÉ g·ª≠i h√†ng ng√†n vote trong v√†i gi√¢y

**Impact:**
- Vote flooding attack
- Resource exhaustion (database)
- DoS (Denial of Service)

---

### 4. **MEDIUM: No CSRF Protection**
**Severity:** üü° MEDIUM
**Location:** T·∫•t c·∫£ POST endpoints

**M√¥ t·∫£:**
- Kh√¥ng c√≥ CSRF token validation
- API c√≥ th·ªÉ ƒë∆∞·ª£c g·ªçi t·ª´ b·∫•t k·ª≥ domain n√†o

**Impact:**
- Cross-Site Request Forgery attacks
- Victim c√≥ th·ªÉ b·ªã d·ª• vote kh√¥ng ch·ªß √Ω

---

### 5. **MEDIUM: Input Validation Weakness**
**Severity:** üü° MEDIUM
**Location:** `app/api/infrastructures/[id]/vote/route.ts:11`

**M√¥ t·∫£:**
- Kh√¥ng validate ƒë·ªãnh d·∫°ng email
- Kh√¥ng gi·ªõi h·∫°n ƒë·ªô d√†i voterName/voterEmail
- Kh√¥ng sanitize input

**Impact:**
- C√≥ th·ªÉ inject d·ªØ li·ªáu ƒë·ªôc h·∫°i
- L∆∞u email fake v√†o database
- Potential XSS n·∫øu render data kh√¥ng ƒë√∫ng c√°ch

---

### 6. **LOW: Information Disclosure**
**Severity:** üü¢ LOW
**Location:** Error responses

**M√¥ t·∫£:**
- Error messages c√≥ th·ªÉ leak th√¥ng tin h·ªá th·ªëng
- Console.error c√≥ th·ªÉ expose stack trace

---

## üõ†Ô∏è K·ªãch b·∫£n T·∫•n c√¥ng (Attack Scenarios)

### Scenario 1: Vote Flooding Attack
**M·ª•c ti√™u:** T·∫°o 10,000 vote cho m·ªôt infrastructure

**Method:**
```bash
# Xem file pentest-scripts/01-vote-flooding.js
```

**Expected Result:**
- T·∫°o th√†nh c√¥ng 10,000 votes
- Vote count tƒÉng kh√¥ng ki·ªÉm so√°t
- Infrastructure target c√≥ s·ªë vote cao nh·∫•t

---

### Scenario 2: IP Spoofing Attack
**M·ª•c ti√™u:** Fake nhi·ªÅu IP kh√°c nhau ƒë·ªÉ bypass tracking

**Method:**
```bash
# Xem file pentest-scripts/02-ip-spoofing.js
```

**Expected Result:**
- M·ªói vote c√≥ IP kh√°c nhau trong database
- Bypass b·∫•t k·ª≥ IP-based limitation n√†o

---

### Scenario 3: CSRF Attack
**M·ª•c ti√™u:** D·ª• victim vote cho infrastructure kh√¥ng mong mu·ªën

**Method:**
```bash
# Xem file pentest-scripts/03-csrf-attack.html
```

**Expected Result:**
- Khi victim m·ªü trang HTML, vote ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông
- Kh√¥ng c·∫ßn victim thao t√°c g√¨

---

### Scenario 4: Mass Infrastructure Creation + Vote Manipulation
**M·ª•c ti√™u:** T·∫°o nhi·ªÅu infrastructure gi·∫£ v√† vote cho ch√∫ng

**Method:**
```bash
# Xem file pentest-scripts/04-mass-manipulation.js
```

**Expected Result:**
- T·∫°o h√†ng lo·∫°t infrastructure spam
- Vote cho t·∫•t c·∫£ ƒë·ªÉ l√†m nhi·ªÖu d·ªØ li·ªáu

---

### Scenario 5: Input Validation Bypass
**M·ª•c ti√™u:** Test v·ªõi input ƒë·ªôc h·∫°i

**Method:**
```bash
# Xem file pentest-scripts/05-input-validation.js
```

**Expected Result:**
- Payload XSS ƒë∆∞·ª£c l∆∞u v√†o database
- SQL injection payloads (should fail v·ªõi Prisma)
- Oversized inputs

---

## üìä Testing Checklist

### Pre-requisites
- [ ] Start application: `yarn dev`
- [ ] C√≥ √≠t nh·∫•t 1 infrastructure trong database
- [ ] Note infrastructure ID ƒë·ªÉ test
- [ ] Install testing tools (curl, Node.js, Postman, etc.)

### Testing Steps

#### 1. Manual Testing v·ªõi cURL
```bash
# 1. L·∫•y danh s√°ch infrastructures
curl http://localhost:3000/api/infrastructures

# 2. Vote ƒë∆°n l·∫ª
curl -X POST http://localhost:3000/api/infrastructures/[ID]/vote \
  -H "Content-Type: application/json" \
  -d '{"voterName":"Hacker","voterEmail":"hacker@test.com"}'

# 3. Vote v·ªõi IP gi·∫£ m·∫°o
curl -X POST http://localhost:3000/api/infrastructures/[ID]/vote \
  -H "Content-Type: application/json" \
  -H "X-Forwarded-For: 1.2.3.4" \
  -d '{"voterName":"Fake IP","voterEmail":"fake@test.com"}'

# 4. Vote flooding (100 l·∫ßn)
for i in {1..100}; do
  curl -X POST http://localhost:3000/api/infrastructures/[ID]/vote \
    -H "Content-Type: application/json" \
    -d "{\"voterName\":\"Bot $i\",\"voterEmail\":\"bot$i@test.com\"}"
done
```

#### 2. Automated Testing
- [ ] Run vote flooding script
- [ ] Run IP spoofing script
- [ ] Test CSRF vulnerability
- [ ] Test input validation bypass
- [ ] Test rate limiting (should fail - no protection)

#### 3. Database Verification
```bash
# Connect to database
docker-compose exec db psql -U vote -d vote_infrastructure

# Check vote count
SELECT infrastructure_id, COUNT(*) as vote_count
FROM votes
GROUP BY infrastructure_id
ORDER BY vote_count DESC;

# Check IP diversity
SELECT ip_address, COUNT(*) as count
FROM votes
GROUP BY ip_address
ORDER BY count DESC;

# Check for XSS payloads
SELECT voter_name, voter_email FROM votes
WHERE voter_name LIKE '%<%' OR voter_email LIKE '%<%';
```

---

## üîß Tools & Commands

### Testing Tools
1. **cURL** - Command line HTTP client
2. **Postman/Insomnia** - API testing GUI
3. **Burp Suite** - Web security testing
4. **OWASP ZAP** - Security scanner
5. **Node.js scripts** - Custom automation

### Useful Commands
```bash
# Monitor API logs
docker-compose logs -f

# Watch database changes in real-time
yarn prisma studio

# Reset database sau khi test
yarn prisma migrate reset

# Check network traffic
# (Use browser DevTools Network tab)
```

---

## üìà Expected Results

### Successful Exploitation
‚úÖ Vote count increase without limit
‚úÖ Different IPs recorded in database
‚úÖ CSRF attack works from external domain
‚úÖ XSS payloads stored in database
‚úÖ No rate limiting blocks rapid requests
‚úÖ No authentication required

### Failed Exploitation (Expected Protections)
‚ùå SQL Injection (Prisma protects against this)
‚ùå NoSQL Injection (Not applicable)

---

## üõ°Ô∏è Recommendations (Mitigation)

### Priority 1: CRITICAL Fixes
1. **Implement Vote Deduplication**
   - Option A: One vote per IP + Infrastructure
   - Option B: One vote per email + Infrastructure
   - Option C: Require authentication + one vote per user

2. **Add Rate Limiting**
   - Implement middleware v·ªõi `@vercel/edge-rate-limit`
   - Limit: 5 votes per IP per hour

### Priority 2: HIGH Fixes
3. **Strengthen IP Detection**
   - Validate IP format
   - Log both x-forwarded-for v√† real IP
   - Consider using Vercel's built-in IP detection

4. **Add CSRF Protection**
   - Implement CSRF tokens
   - Validate Origin/Referer headers

### Priority 3: MEDIUM Fixes
5. **Input Validation & Sanitization**
   - Validate email format
   - Limit name/email length (max 100 chars)
   - Sanitize inputs before storage
   - Escape outputs when rendering

6. **Add Authentication**
   - Implement NextAuth.js
   - Require login to vote
   - Track votes by user ID instead of IP

### Priority 4: LOW Fixes
7. **Improve Error Handling**
   - Don't expose stack traces
   - Use generic error messages
   - Log details server-side only

---

## üìù Report Template

```markdown
# Penetration Test Report - Voting Feature

**Tester:** [Your Name]
**Date:** [Test Date]
**Target:** Infrastructure Voting System
**Scope:** Voting functionality

## Executive Summary
[Summary of findings]

## Vulnerabilities Found
| ID | Severity | Vulnerability | Status |
|----|----------|---------------|---------|
| V1 | Critical | Unlimited Vote Manipulation | Confirmed |
| V2 | High | IP Spoofing | Confirmed |
| ... | ... | ... | ... |

## Detailed Findings
[For each vulnerability: description, steps to reproduce, impact, recommendation]

## Proof of Concept
[Screenshots, logs, evidence]

## Risk Assessment
- Critical: X
- High: Y
- Medium: Z
- Low: W

## Recommendations
[Prioritized list of fixes]
```

---

## ‚ö†Ô∏è Legal & Ethics Notice

**C·∫¢NH B√ÅO:**
- Ch·ªâ pentest tr√™n h·ªá th·ªëng c·ªßa CH√çNH B·∫†N
- KH√îNG pentest h·ªá th·ªëng c·ªßa ng∆∞·ªùi kh√°c m√† kh√¥ng c√≥ authorization
- Backup database tr∆∞·ªõc khi test
- Test tr√™n m√¥i tr∆∞·ªùng development, KH√îNG tr√™n production
- Tu√¢n th·ªß lu·∫≠t ph√°p v·ªÅ an ninh m·∫°ng

**Responsible Disclosure:**
- N·∫øu ph√°t hi·ªán l·ªó h·ªïng tr√™n h·ªá th·ªëng th·ª±c t·∫ø c·ªßa t·ªï ch·ª©c kh√°c, b√°o c√°o cho h·ªç tr∆∞·ªõc khi public
- ƒê·ª£i patch ƒë∆∞·ª£c release tr∆∞·ªõc khi c√¥ng b·ªë chi ti·∫øt
- Tu√¢n th·ªß responsible disclosure timeline (th∆∞·ªùng 90 ng√†y)

---

## üìö References

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
- [PortSwigger Web Security Academy](https://portswigger.net/web-security)
- [HackerOne Disclosure Guidelines](https://www.hackerone.com/disclosure-guidelines)

---

**Last Updated:** 2025-11-25
**Version:** 1.0
