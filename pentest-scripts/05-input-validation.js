#!/usr/bin/env node

/**
 * PENTEST SCRIPT: Input Validation & Injection Testing
 *
 * Má»¥c tiÃªu: Test input validation, sanitization, vÃ  injection vulnerabilities
 * Severity: MEDIUM to CRITICAL
 *
 * Usage:
 *   node 05-input-validation.js <infrastructure-id> [base-url]
 *
 * Example:
 *   node 05-input-validation.js clx123abc
 */

const BASE_URL = process.argv[3] || 'http://localhost:3000';
const INFRASTRUCTURE_ID = process.argv[2];

if (!INFRASTRUCTURE_ID) {
  console.error('âŒ Error: Infrastructure ID is required');
  console.log('Usage: node 05-input-validation.js <infrastructure-id> [base-url]');
  process.exit(1);
}

console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      ğŸ§ª INPUT VALIDATION TESTING - PENTEST               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Target Infrastructure: ${INFRASTRUCTURE_ID}
Base URL: ${BASE_URL}
Attack Type: Input Validation Bypass & Injection

[!] Testing with malicious payloads
[!] Checking for XSS, SQL injection, and other attacks
`);

// Test payloads
const testPayloads = [
  {
    name: 'XSS - Basic Script Tag',
    severity: 'CRITICAL',
    voterName: '<script>alert("XSS")</script>',
    voterEmail: 'xss@test.com',
    expectedIssue: 'Stored XSS if rendered without escaping'
  },
  {
    name: 'XSS - Event Handler',
    severity: 'CRITICAL',
    voterName: '<img src=x onerror="alert(\'XSS\')">',
    voterEmail: 'xss2@test.com',
    expectedIssue: 'Stored XSS via event handler'
  },
  {
    name: 'XSS - SVG Payload',
    severity: 'CRITICAL',
    voterName: '<svg/onload=alert(1)>',
    voterEmail: 'xss3@test.com',
    expectedIssue: 'SVG-based XSS'
  },
  {
    name: 'XSS - In Email Field',
    severity: 'CRITICAL',
    voterName: 'Normal User',
    voterEmail: '"><script>alert("XSS")</script>',
    expectedIssue: 'XSS in email attribute'
  },
  {
    name: 'SQL Injection - Classic Quote',
    severity: 'CRITICAL',
    voterName: "'; DROP TABLE votes; --",
    voterEmail: 'sqli@test.com',
    expectedIssue: 'SQL injection (should be blocked by Prisma)'
  },
  {
    name: 'SQL Injection - UNION Attack',
    severity: 'CRITICAL',
    voterName: "' UNION SELECT * FROM users--",
    voterEmail: 'sqli2@test.com',
    expectedIssue: 'SQL injection attempt'
  },
  {
    name: 'SQL Injection - Time-based Blind',
    severity: 'CRITICAL',
    voterName: "'; WAITFOR DELAY '00:00:05'--",
    voterEmail: 'sqli3@test.com',
    expectedIssue: 'Time-based blind SQL injection'
  },
  {
    name: 'NoSQL Injection - MongoDB',
    severity: 'HIGH',
    voterName: '{"$ne": null}',
    voterEmail: 'nosqli@test.com',
    expectedIssue: 'NoSQL injection (not applicable to PostgreSQL)'
  },
  {
    name: 'Command Injection',
    severity: 'CRITICAL',
    voterName: '; ls -la; cat /etc/passwd',
    voterEmail: 'cmdi@test.com',
    expectedIssue: 'Command injection attempt'
  },
  {
    name: 'Path Traversal',
    severity: 'HIGH',
    voterName: '../../etc/passwd',
    voterEmail: 'path@test.com',
    expectedIssue: 'Path traversal attempt'
  },
  {
    name: 'LDAP Injection',
    severity: 'MEDIUM',
    voterName: '*)(uid=*))(|(uid=*',
    voterEmail: 'ldap@test.com',
    expectedIssue: 'LDAP injection (not applicable)'
  },
  {
    name: 'XML External Entity (XXE)',
    severity: 'HIGH',
    voterName: '<?xml version="1.0"?><!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]><foo>&xxe;</foo>',
    voterEmail: 'xxe@test.com',
    expectedIssue: 'XXE injection (not applicable to JSON)'
  },
  {
    name: 'Template Injection',
    severity: 'HIGH',
    voterName: '{{7*7}}',
    voterEmail: 'template@test.com',
    expectedIssue: 'Server-side template injection'
  },
  {
    name: 'Null Byte Injection',
    severity: 'MEDIUM',
    voterName: 'test\x00admin',
    voterEmail: 'null@test.com',
    expectedIssue: 'Null byte injection'
  },
  {
    name: 'CRLF Injection',
    severity: 'MEDIUM',
    voterName: 'test\r\nSet-Cookie: admin=true',
    voterEmail: 'crlf@test.com',
    expectedIssue: 'CRLF injection / HTTP response splitting'
  },
  {
    name: 'Oversized Input - Name',
    severity: 'MEDIUM',
    voterName: 'A'.repeat(10000),
    voterEmail: 'long@test.com',
    expectedIssue: 'DoS via oversized input, no length validation'
  },
  {
    name: 'Oversized Input - Email',
    severity: 'MEDIUM',
    voterName: 'Normal User',
    voterEmail: 'a'.repeat(5000) + '@test.com',
    expectedIssue: 'DoS via oversized email'
  },
  {
    name: 'Invalid Email Format',
    severity: 'LOW',
    voterName: 'Normal User',
    voterEmail: 'not-an-email',
    expectedIssue: 'No email format validation'
  },
  {
    name: 'Email with Script',
    severity: 'MEDIUM',
    voterName: 'Normal User',
    voterEmail: 'test@example.com<script>alert(1)</script>',
    expectedIssue: 'XSS in email field'
  },
  {
    name: 'Unicode Bypass',
    severity: 'MEDIUM',
    voterName: '\u003cscript\u003ealert(1)\u003c/script\u003e',
    voterEmail: 'unicode@test.com',
    expectedIssue: 'Unicode-encoded XSS'
  },
  {
    name: 'Polyglot Payload',
    severity: 'CRITICAL',
    voterName: 'javascript:/*--></title></style></textarea></script></xmp><svg/onload=\'+/"/+/onmouseover=1/+/[*/[]/+alert(1)//\'>',
    voterEmail: 'polyglot@test.com',
    expectedIssue: 'Polyglot XSS payload'
  },
  {
    name: 'Empty/Null Values',
    severity: 'LOW',
    voterName: null,
    voterEmail: null,
    expectedIssue: 'Null value handling'
  },
  {
    name: 'Boolean Injection',
    severity: 'LOW',
    voterName: true,
    voterEmail: false,
    expectedIssue: 'Type confusion'
  },
  {
    name: 'Array Injection',
    severity: 'MEDIUM',
    voterName: ['admin', 'user'],
    voterEmail: ['test@example.com'],
    expectedIssue: 'Type confusion / mass assignment'
  },
  {
    name: 'Object Injection',
    severity: 'HIGH',
    voterName: { __proto__: { isAdmin: true } },
    voterEmail: 'object@test.com',
    expectedIssue: 'Prototype pollution'
  }
];

async function testPayload(payload) {
  try {
    const response = await fetch(`${BASE_URL}/api/infrastructures/${INFRASTRUCTURE_ID}/vote`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        voterName: payload.voterName,
        voterEmail: payload.voterEmail
      })
    });

    const data = await response.json();

    return {
      success: response.ok,
      status: response.status,
      data: data,
      payload: payload
    };
  } catch (error) {
    return {
      success: false,
      error: error.message,
      payload: payload
    };
  }
}

async function runTests() {
  console.log('ğŸš€ Starting input validation tests...\n');

  const results = {
    passed: [],
    blocked: [],
    errors: []
  };

  for (let i = 0; i < testPayloads.length; i++) {
    const payload = testPayloads[i];
    console.log(`\n[${i + 1}/${testPayloads.length}] Testing: ${payload.name}`);
    console.log(`   Severity: ${payload.severity}`);
    console.log(`   Expected Issue: ${payload.expectedIssue}`);

    const result = await testPayload(payload);

    if (result.error) {
      console.log(`   âŒ Error: ${result.error}`);
      results.errors.push(result);
    } else if (result.success) {
      console.log(`   ğŸ”´ PASSED: Payload accepted! (Potential vulnerability)`);
      console.log(`   Status: ${result.status}`);
      console.log(`   Vote ID: ${result.data.vote?.id || 'N/A'}`);
      results.passed.push(result);
    } else {
      console.log(`   ğŸŸ¢ BLOCKED: Payload rejected (Good)`);
      console.log(`   Status: ${result.status} - ${result.data.error || 'Unknown'}`);
      results.blocked.push(result);
    }

    // Small delay between tests
    await new Promise(resolve => setTimeout(resolve, 200));
  }

  // Print summary
  console.log(`\n\n${'='.repeat(70)}`);
  console.log('ğŸ“Š TEST SUMMARY');
  console.log('='.repeat(70));
  console.log(`Total Tests: ${testPayloads.length}`);
  console.log(`ğŸ”´ Payloads Accepted (Vulnerabilities): ${results.passed.length}`);
  console.log(`ğŸŸ¢ Payloads Blocked: ${results.blocked.length}`);
  console.log(`âŒ Errors: ${results.errors.length}`);
  console.log('='.repeat(70));

  if (results.passed.length > 0) {
    console.log('\nğŸ”´ VULNERABILITIES FOUND:');
    console.log('='.repeat(70));
    results.passed.forEach((result, idx) => {
      console.log(`\n${idx + 1}. ${result.payload.name} (${result.payload.severity})`);
      console.log(`   Issue: ${result.payload.expectedIssue}`);
      console.log(`   Payload Name: ${JSON.stringify(result.payload.voterName)}`);
      console.log(`   Payload Email: ${JSON.stringify(result.payload.voterEmail)}`);
      console.log(`   Vote ID: ${result.data.vote?.id}`);
    });
  }

  console.log('\n\nğŸ” VULNERABILITY ASSESSMENT:');
  console.log('='.repeat(70));

  // Categorize by severity
  const critical = results.passed.filter(r => r.payload.severity === 'CRITICAL');
  const high = results.passed.filter(r => r.payload.severity === 'HIGH');
  const medium = results.passed.filter(r => r.payload.severity === 'MEDIUM');
  const low = results.passed.filter(r => r.payload.severity === 'LOW');

  if (critical.length > 0) {
    console.log(`ğŸ”´ CRITICAL: ${critical.length} critical vulnerabilities found!`);
    console.log('   â†’ Immediate action required!');
  }
  if (high.length > 0) {
    console.log(`ğŸŸ  HIGH: ${high.length} high-severity vulnerabilities found`);
  }
  if (medium.length > 0) {
    console.log(`ğŸŸ¡ MEDIUM: ${medium.length} medium-severity issues found`);
  }
  if (low.length > 0) {
    console.log(`ğŸŸ¢ LOW: ${low.length} low-severity issues found`);
  }

  if (results.passed.length === 0) {
    console.log('ğŸŸ¢ EXCELLENT: All malicious payloads were blocked!');
    console.log('   â†’ Input validation appears to be working');
  }

  console.log('\nğŸ’¡ RECOMMENDATIONS:');
  console.log('='.repeat(70));
  console.log('  1. Validate and sanitize ALL user inputs');
  console.log('  2. Implement email format validation (RFC 5322)');
  console.log('  3. Set maximum length limits (name: 100, email: 320 chars)');
  console.log('  4. Use parameterized queries (Prisma already does this)');
  console.log('  5. Escape all output when rendering (React does this by default)');
  console.log('  6. Implement Content Security Policy (CSP)');
  console.log('  7. Add type validation to reject non-string inputs');
  console.log('  8. Consider using a validation library (zod, joi, yup)');

  console.log('\nğŸ§¹ DATABASE CHECK:');
  console.log('='.repeat(70));
  console.log('  Run these commands to verify stored payloads:');
  console.log('  ');
  console.log('  docker-compose exec db psql -U vote -d vote_infrastructure');
  console.log('  ');
  console.log('  SELECT id, voter_name, voter_email, created_at');
  console.log(`  FROM votes WHERE infrastructure_id = '${INFRASTRUCTURE_ID}'`);
  console.log(`  ORDER BY created_at DESC LIMIT 30;`);
  console.log('  ');
  console.log('  # Check for XSS payloads');
  console.log('  SELECT * FROM votes WHERE voter_name LIKE \'%<%\' OR voter_email LIKE \'%<%\';');
  console.log('  ');
  console.log('  # Delete test payloads');
  console.log(`  DELETE FROM votes WHERE infrastructure_id = '${INFRASTRUCTURE_ID}'`);
  console.log('  AND voter_email LIKE \'%@test.com\';');

  console.log('\nğŸ“ NEXT STEPS:');
  console.log('='.repeat(70));
  console.log('  1. Review database for stored payloads');
  console.log('  2. Test rendering of stored data in browser (check for XSS)');
  console.log('  3. Implement input validation fixes');
  console.log('  4. Re-run this test after fixes');
  console.log('  5. Add automated validation tests to CI/CD');
}

console.log('âš ï¸  WARNING: This will send malicious payloads!');
console.log('   Press Ctrl+C to cancel, or wait 3 seconds to continue...\n');

setTimeout(() => {
  runTests().catch(error => {
    console.error('\nâŒ Test failed:', error.message);
    process.exit(1);
  });
}, 3000);
