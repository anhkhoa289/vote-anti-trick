# Penetration Testing Scripts

B·ªô c√¥ng c·ª• pentest cho ch·ª©c nƒÉng voting c·ªßa Infrastructure Voting System.

## ‚ö†Ô∏è Disclaimer

**C·∫¢NH B√ÅO:** C√°c script n√†y ƒë∆∞·ª£c thi·∫øt k·∫ø cho m·ª•c ƒë√≠ch ki·ªÉm tra b·∫£o m·∫≠t (security testing) v√† ch·ªâ n√™n ƒë∆∞·ª£c s·ª≠ d·ª•ng tr√™n:
- H·ªá th·ªëng c·ªßa ch√≠nh b·∫°n
- M√¥i tr∆∞·ªùng development/testing
- V·ªõi s·ª± cho ph√©p r√µ r√†ng t·ª´ ch·ªß s·ªü h·ªØu h·ªá th·ªëng

**KH√îNG BAO GI·ªú** s·ª≠ d·ª•ng c√°c script n√†y tr√™n h·ªá th·ªëng c·ªßa ng∆∞·ªùi kh√°c m√† kh√¥ng c√≥ authorization.

## üìã Prerequisites

1. **Node.js** installed (v18 or higher)
2. **Application running** at `http://localhost:3000` (or specify custom URL)
3. **At least one infrastructure** created in the system
4. **Database access** for verification (optional but recommended)

## üõ†Ô∏è Scripts Overview

### 1. Vote Flooding Attack (`01-vote-flooding.js`)
**Severity:** üî¥ CRITICAL

Test kh·∫£ nƒÉng ch·ªëng spam vote c·ªßa h·ªá th·ªëng.

```bash
node 01-vote-flooding.js <infrastructure-id> [count] [base-url]

# Example: T·∫°o 1000 votes
node 01-vote-flooding.js clx123abc 1000

# Custom URL
node 01-vote-flooding.js clx123abc 100 http://localhost:3000
```

**What it tests:**
- Vote deduplication
- Rate limiting
- Resource exhaustion protection

**Expected vulnerability:** System accepts unlimited votes without validation.

---

### 2. IP Spoofing Attack (`02-ip-spoofing.js`)
**Severity:** üü† HIGH

Test kh·∫£ nƒÉng gi·∫£ m·∫°o IP address ƒë·ªÉ bypass tracking.

```bash
node 02-ip-spoofing.js <infrastructure-id> [count] [base-url]

# Example: 50 votes v·ªõi 50 fake IPs
node 02-ip-spoofing.js clx123abc 50
```

**What it tests:**
- IP header validation
- Trust in X-Forwarded-For header
- IP-based access control

**Expected vulnerability:** System trusts client-provided IP headers.

---

### 3. CSRF Attack (`03-csrf-attack.html`)
**Severity:** üü° MEDIUM

Test l·ªó h·ªïng Cross-Site Request Forgery.

```bash
# Open trong browser
open 03-csrf-attack.html
# ho·∫∑c
firefox 03-csrf-attack.html
```

**What it tests:**
- CSRF token validation
- Origin/Referer header checking
- SameSite cookie protection

**Expected vulnerability:** No CSRF protection, allowing cross-origin requests.

**Usage:**
1. Replace `[INFRASTRUCTURE-ID]` v·ªõi ID th·ª±c t·∫ø
2. Click "Execute Manual CSRF Attack"
3. Ho·∫∑c enable "Auto-attack on page load" checkbox

---

### 4. Mass Manipulation (`04-mass-manipulation.js`)
**Severity:** üü† HIGH

Test kh·∫£ nƒÉng t·∫°o spam h√†ng lo·∫°t v√† vote flooding.

```bash
node 04-mass-manipulation.js [infra-count] [votes-per-infra] [base-url]

# Example: 20 spam infrastructures, m·ªói c√°i 100 votes
node 04-mass-manipulation.js 20 100
```

**What it tests:**
- Infrastructure creation spam
- Combined attack (spam + vote flooding)
- Database resilience
- Content validation

**Expected vulnerability:** No spam detection, allows mass creation and voting.

‚ö†Ô∏è **Warning:** Script n√†y t·∫°o nhi·ªÅu data spam! C·∫ßn cleanup sau khi test.

---

### 5. Input Validation (`05-input-validation.js`)
**Severity:** üî¥ CRITICAL (if XSS found)

Test input validation v√† injection vulnerabilities.

```bash
node 05-input-validation.js <infrastructure-id> [base-url]

# Example
node 05-input-validation.js clx123abc
```

**What it tests:**
- XSS (Cross-Site Scripting)
- SQL Injection
- Command Injection
- Path Traversal
- Oversized inputs
- Type confusion
- Email validation

**Expected vulnerability:** Accepts malicious payloads without sanitization.

---

## üöÄ Quick Start Guide

### Step 1: Setup Environment

```bash
# Start application
cd /path/to/vote-anti-trick
yarn dev

# In another terminal, start database (if not running)
docker-compose up -d
```

### Step 2: Get Infrastructure ID

```bash
# Option 1: Via API
curl http://localhost:3000/api/infrastructures | json_pp

# Option 2: Via database
docker-compose exec db psql -U vote -d vote_infrastructure -c \
  "SELECT id, name FROM infrastructures LIMIT 5;"

# Option 3: Via Prisma Studio
yarn prisma studio
# Browse to http://localhost:5555
```

### Step 3: Run Tests

```bash
cd pentest-scripts

# Make scripts executable
chmod +x *.js

# Run individual tests
node 01-vote-flooding.js <your-infrastructure-id> 100
node 02-ip-spoofing.js <your-infrastructure-id> 50
node 05-input-validation.js <your-infrastructure-id>

# For CSRF test, open HTML in browser
```

### Step 4: Verify Results

```bash
# Check database
docker-compose exec db psql -U vote -d vote_infrastructure

# Count votes
SELECT infrastructure_id, COUNT(*) as vote_count
FROM votes
GROUP BY infrastructure_id
ORDER BY vote_count DESC;

# Check for malicious payloads
SELECT voter_name, voter_email FROM votes
WHERE voter_name LIKE '%<%' OR voter_email LIKE '%<%'
LIMIT 10;

# Check IP diversity
SELECT ip_address, COUNT(*) FROM votes
GROUP BY ip_address
ORDER BY COUNT(*) DESC
LIMIT 10;
```

### Step 5: Cleanup

```bash
# Delete test votes
docker-compose exec db psql -U vote -d vote_infrastructure -c \
  "DELETE FROM votes WHERE voter_email LIKE '%@test.com';"

# Delete spam infrastructures
docker-compose exec db psql -U vote -d vote_infrastructure -c \
  "DELETE FROM infrastructures WHERE description LIKE '%SPAM SPAM%';"

# Nuclear option: Reset everything
yarn prisma migrate reset
```

---

## üìä Test Results Interpretation

### üî¥ Critical Issues
- **All votes pass without limitation** ‚Üí No vote deduplication
- **Fake IPs accepted** ‚Üí IP spoofing works
- **XSS payloads stored** ‚Üí Potential stored XSS
- **SQL injection successful** ‚Üí Database compromise (unlikely v·ªõi Prisma)

### üü† High Issues
- **Mass spam creation works** ‚Üí No spam protection
- **CSRF attack successful** ‚Üí Missing CSRF tokens
- **No rate limiting** ‚Üí DoS vulnerability

### üü° Medium Issues
- **Invalid email formats accepted** ‚Üí Weak validation
- **Oversized inputs accepted** ‚Üí Potential DoS

### üü¢ Good Signs
- **Prisma blocks SQL injection** ‚Üí ORM protection working
- **Payloads rejected** ‚Üí Input validation working
- **CORS errors** ‚Üí Some cross-origin protection

---

## üõ°Ô∏è Mitigation Checklist

After running tests, implement these fixes:

### Priority 1: Critical
- [ ] Implement vote deduplication (one vote per IP/user/email)
- [ ] Add rate limiting on all endpoints
- [ ] Validate and sanitize all inputs
- [ ] Fix stored XSS vulnerabilities

### Priority 2: High
- [ ] Add CSRF protection (tokens or SameSite cookies)
- [ ] Strengthen IP detection (don't trust X-Forwarded-For alone)
- [ ] Implement spam detection
- [ ] Add authentication for infrastructure creation

### Priority 3: Medium
- [ ] Validate email format (RFC 5322)
- [ ] Set input length limits
- [ ] Add CAPTCHA for bot protection
- [ ] Implement Content Security Policy

### Priority 4: Low
- [ ] Improve error messages (don't leak info)
- [ ] Add monitoring and alerting
- [ ] Implement admin moderation tools

---

## üìà Advanced Testing

### Automated CI/CD Integration

Add to your CI/CD pipeline:

```yaml
# .github/workflows/security-test.yml
name: Security Tests

on: [pull_request]

jobs:
  pentest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup
        run: |
          yarn install
          docker-compose up -d
          yarn prisma migrate deploy
      - name: Run Security Tests
        run: |
          yarn dev &
          sleep 10
          cd pentest-scripts
          node 01-vote-flooding.js $TEST_ID 10 || exit 0
          # Expect failure = protection exists
```

### Using Burp Suite

1. Configure Burp as proxy
2. Capture vote request
3. Send to Repeater
4. Modify headers/payload
5. Analyze responses

### Using OWASP ZAP

```bash
# Automated scan
docker run -v $(pwd):/zap/wrk/:rw \
  -t owasp/zap2docker-stable zap-baseline.py \
  -t http://localhost:3000 -r report.html
```

---

## üìö Resources

### Documentation
- [Main Pentest Guide](../docs/PENTEST_VOTING.md)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)

### Tools
- [Burp Suite](https://portswigger.net/burp)
- [OWASP ZAP](https://www.zaproxy.org/)
- [curl](https://curl.se/)
- [Postman](https://www.postman.com/)

### Learning
- [PortSwigger Academy](https://portswigger.net/web-security)
- [HackerOne Hacktivity](https://hackerone.com/hacktivity)
- [OWASP WebGoat](https://owasp.org/www-project-webgoat/)

---

## ü§ù Contributing

Found new vulnerabilities or have additional test cases?

1. Document the vulnerability
2. Write a test script
3. Add to this collection
4. Share responsible disclosure

---

## üìû Support

Questions or issues?
1. Check [PENTEST_VOTING.md](../docs/PENTEST_VOTING.md)
2. Review test output carefully
3. Verify database state
4. Check application logs

---

## ‚öñÔ∏è Legal Notice

These tools are for **AUTHORIZED TESTING ONLY**.

- ‚úÖ DO: Test your own systems
- ‚úÖ DO: Test with permission
- ‚úÖ DO: Report findings responsibly
- ‚ùå DON'T: Attack others' systems
- ‚ùå DON'T: Use for malicious purposes
- ‚ùå DON'T: Test production without backup

**Violating computer security laws is a crime. Use responsibly.**

---

**Version:** 1.0
**Last Updated:** 2025-11-25
**License:** For educational and authorized testing only
